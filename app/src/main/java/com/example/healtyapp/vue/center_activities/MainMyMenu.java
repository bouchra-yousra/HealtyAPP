package com.example.healtyapp.vue.center_activities;import android.annotation.SuppressLint;import android.content.Intent;import android.content.SharedPreferences;import android.os.Bundle;import android.view.View;import android.widget.LinearLayout;import android.widget.ProgressBar;import android.widget.TextView;import android.widget.Toast;import com.example.healtyapp.R;import com.example.healtyapp.database_item.AlimentData;import com.example.healtyapp.dialogue.TestInflate;import com.example.healtyapp.database_item.Aliment;import com.example.healtyapp.module.ExerciceCognitive;import com.example.healtyapp.module.ExercicePhysique;import com.example.healtyapp.module.User;import com.example.healtyapp.ui.activitymorale.ActivitymoraleFragment;import com.example.healtyapp.ui.activityphysic.ActivityphysicFragment;import com.example.healtyapp.ui.activityphysic.MainChrono;import com.example.healtyapp.ui.home.HomeFragment;import com.example.healtyapp.ui.profile.ProfileFragment;import com.google.android.material.bottomnavigation.BottomNavigationView;import com.google.firebase.database.DataSnapshot;import com.google.firebase.database.DatabaseError;import com.google.firebase.database.DatabaseReference;import com.google.firebase.database.FirebaseDatabase;import com.google.firebase.database.ValueEventListener;import androidx.annotation.NonNull;import androidx.appcompat.app.AppCompatActivity;import androidx.navigation.NavController;import androidx.navigation.Navigation;import androidx.navigation.ui.AppBarConfiguration;import androidx.navigation.ui.NavigationUI;import java.util.ArrayList;import java.util.Calendar;import java.util.HashMap;import java.util.Locale;/** * has all the important information of a user */public class MainMyMenu extends AppCompatActivity implements TestInflate.TestInflateLisnner {    //GLOBALE:    //__user infos    public static double kca;    public static double bes_eau;    public static String sexe;    public static double poids;    //__SharedPreferences    public static final String Share = "UserData";    public static final String MyUser = "MyUser";    SharedPreferences sharedPreferences;    //____Shared elements    public static final String PROGRESS_NUTRITION = "currentKca";    public static final String PROGRESS_PHYSIQUE = "progress_physique";    public static final String PROGRESS_COGNITIVE = "progress_cognitive";    public static final String PROGRESS_COGNITIVE_TIME = "progress_cognitive_time";    public static final String PROGRESS_WATER = "currentWater";    //database    DatabaseReference myDatabase,myDatabase2;    public static ArrayList<Aliment> arrayList = new ArrayList<>();    public static ArrayList<ExercicePhysique> exercicePhysiqueArrayList = new ArrayList<>();    public static ArrayList<ExerciceCognitive> exerciceCognitives = new ArrayList<>();    public static User user ;    public static HashMap maladie_exo = new HashMap();    //collection the intfos (progressions)    public static int progress_physique;    public static int progress_cognitive;    public static int progress_nutrition;    public static int progress_water;    //today    Calendar calSelected = Calendar.getInstance();    String today = "" + calSelected.get(Calendar.DAY_OF_MONTH)            + (calSelected.get(Calendar.MONTH) + 1)            + calSelected.get(Calendar.YEAR);    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.my_menu);        sharedPreferences = getSharedPreferences(Share,MODE_PRIVATE);        //share = getSharedPreferences(Share,MODE_PRIVATE);        BottomNavigationView navView = findViewById(R.id.nav_view);        kca = getIntent().getDoubleExtra("Kca", 99);        bes_eau = getIntent().getDoubleExtra("ml", 0);        sexe = getIntent().getStringExtra("Sexe");        putMAX (kca);        //double p = Double.parseDouble(user.getPoids());        double p;        //p=52;        assert user.getPoids() != null;        //p = Double.parseDouble(user.getPoids());        poids = getIntent().getDoubleExtra("Poids",50);        if (user != null) {            HomeFragment.user = MainMyMenu.user;            if( kca == 0)                kca = (int) user.getBesoin_energy();            if( bes_eau == 0)                bes_eau = (int) user.getBesoin_eau();        }        //get all aliments saved on databse        getAll();        //get all activities 'physique' from the database        getAllEXOS();        getExoM();        //create un botton navigation menu with passsing the layout id for all the menu fragments        AppBarConfiguration appBarConfiguration = new AppBarConfiguration.Builder(                R.id.navigation_home, R.id.navigation_activityphysic, R.id.navigation_activitymorale,                R.id.navigation_nuttrision, R.id.navigation_profile)                .build();        NavController navController = Navigation.findNavController(this, R.id.nav_host_fragment);        //NavigationUI.setupActionBarWithNavController(this, navController, appBarConfiguration);        NavigationUI.setupWithNavController(navView, navController);        //reinisialisation d'app (everyday)        initapp();        //home rec physique        getRecList_home(5);        HomeFragment.RecList_home = MainMyMenu.exercicePhysiqueArrayList;        //si il y a une progression dans la bdd mais non  dans la variable share        update_share_progression ();        //gererlayout(HomeFragment.lay1,HomeFragment.lay2);    }    private void gererlayout(LinearLayout lay1, LinearLayout lay2) {        if (sharedPreferences.getInt(PROGRESS_NUTRITION,0) == 0) {            lay2.setVisibility(View.VISIBLE);            lay1.setVisibility(View.GONE);        } else {            lay1.setVisibility(View.VISIBLE);            lay2.setVisibility(View.GONE);        }    }    private void putMAX(double kca) {        SharedPreferences.Editor editor = sharedPreferences.edit();        editor.putInt("MAX1", ((int)kca/3));        editor.putInt("MAX2", (int)kca);        editor.apply();    }    private void update_share_progression() {        if (!sharedPreferences.contains(PROGRESS_COGNITIVE)) {           // getProgressCognitive ();        }        if (!sharedPreferences.contains(PROGRESS_PHYSIQUE)){            //getProgressionPhysique();            getProgressionPhysique_cognitive();        }        if (!sharedPreferences.contains(PROGRESS_NUTRITION)){            getProgressionNutrition();        }        if (!sharedPreferences.contains(PROGRESS_WATER)){            getProgressionWater ();        }        showMsg(String.valueOf(sharedPreferences.getInt(PROGRESS_PHYSIQUE,0)));        showMsg(String.valueOf(sharedPreferences.getInt(PROGRESS_NUTRITION,0)));        showMsg(String.valueOf(sharedPreferences.getInt(PROGRESS_WATER,0)));    }    //get all aliments saved on databse    public void getAll() {        myDatabase = FirebaseDatabase.getInstance().getReference().child("Aliments");        arrayList =  new ArrayList<>();        myDatabase.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                for (DataSnapshot snapshot : dataSnapshot.getChildren()) {                    Aliment aliment = snapshot.getValue(Aliment.class);                    //Add a new aliment in static arrayList                    arrayList.add(aliment);                }            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });    }    //get all activities 'physique' from the database    public void getAllEXOS() {        myDatabase = FirebaseDatabase.getInstance().getReference().child("ActivityPh");        exercicePhysiqueArrayList = new ArrayList<>();        myDatabase.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                for (DataSnapshot snapshot : dataSnapshot.getChildren()) {                    ExercicePhysique exercicePhysique = snapshot.getValue(ExercicePhysique.class);                    //Add ActPh in static arraylist                    exercicePhysiqueArrayList.add(exercicePhysique);                }            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });    }    private void getExoM(){        myDatabase2 =FirebaseDatabase.getInstance().getReference().child("ActivityM");        exerciceCognitives = new ArrayList<>();        myDatabase2.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                for(DataSnapshot snapshot : dataSnapshot.getChildren()){                    ExerciceCognitive exerciceCognitive = snapshot.getValue(ExerciceCognitive.class);                    exerciceCognitives.add(exerciceCognitive);                }            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });    }    public void showMsg( String s){        Toast.makeText(getApplicationContext(),s,Toast.LENGTH_SHORT).show();    }    //DATA    private void getProgressionNutrition(){        DatabaseReference root = FirebaseDatabase.getInstance().getReference().child("UserActivitys").child(MainMyMenu.user.getIdUser());        root.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                if (dataSnapshot.exists()) {                }                else                    return;            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });        DatabaseReference databaseReference = FirebaseDatabase.getInstance().getReference().child("UserActivitys").child(getSharedPreferences(MainActivity.MyUser, MODE_PRIVATE).getString("UserId", MainMyMenu.user.getIdUser())).child(today).child("Nutrition");        databaseReference.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                int resultat_progression = 0;                int p = 0,l = 0,g = 0;                for(DataSnapshot snapshot : dataSnapshot.getChildren()){                    int quantite = 0;                    if (snapshot.exists()) {                        if (snapshot.child("nom").exists()) {                            String nom = snapshot.child("nom").getValue(String.class);                            if (snapshot.child("quantite").exists())                                quantite = (int) snapshot.child("quantite").getValue(Integer.class);                            AlimentData a = new AlimentData (nom,quantite);                            if (getAliment(a) != null){                                resultat_progression += convertQttoClAliment(quantite, getAliment(a));                                p += (int) convertQttoClAliment(quantite,getAliment(a).getCalorie().getProtine());                                g += (int) convertQttoClAliment(quantite,getAliment(a).getCalorie().getGlicide());                                l += (int) convertQttoClAliment(quantite,getAliment(a).getCalorie().getLipide());                            }                        }                    }                }                Updates_nut(resultat_progression);                Updates_plus(p,l,g);            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });    }    private void getProgressionWater(){        if (user.getIdUser() == null)            return;        DatabaseReference root = FirebaseDatabase.getInstance().getReference().child("UserActivitys").child(MainMyMenu.user.getIdUser());        root.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                if (dataSnapshot.exists()) {                }                else                    return;            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });        DatabaseReference databaseReference = FirebaseDatabase.getInstance().getReference().child("UserActivitys").child(MainMyMenu.user.getIdUser()).child(today);        databaseReference.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                if (dataSnapshot.exists()) {                    int progn = 0;                    if (dataSnapshot.child("Progressions").exists()) {                        if (dataSnapshot.child("Progressions").child("Water").exists())                            progn = dataSnapshot.child("Progressions").child("Water").getValue(Integer.class);                    }                    Updates_water (progn);                }            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });        //animate_progressbar(pro1);    }    private void getProgressionPhysique(){        DatabaseReference root = FirebaseDatabase.getInstance().getReference().child("UserActivitys").child(MainMyMenu.user.getIdUser());        root.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                if (dataSnapshot.exists()) {                }                else                    return;            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });        DatabaseReference databaseReference = FirebaseDatabase.getInstance().getReference().child("UserActivitys").child(MainMyMenu.user.getIdUser()).child(today);        databaseReference.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                if (dataSnapshot.exists()) {                    int progn = 0;                    if (dataSnapshot.child("Progressions").exists()) {                        if (dataSnapshot.child("Progressions").child("Physique").exists())                            progn = dataSnapshot.child("Progressions").child("Physique").getValue(Integer.class);                    }                    update_progress (progn);                }            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });    }    private void getProgressionPhysique_cognitive(){        DatabaseReference root = FirebaseDatabase.getInstance().getReference().child("UserActivitys").child(MainMyMenu.user.getIdUser());        root.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                if (dataSnapshot.exists()) {                }                else                    return;            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });        DatabaseReference databaseReference = FirebaseDatabase.getInstance().getReference().child("UserActivitys").child(MainMyMenu.user.getIdUser()).child(today);        databaseReference.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                if (dataSnapshot.exists()) {                    int progn = 0,p = 0;                    if (dataSnapshot.child("Progressions").exists()) {                        if (dataSnapshot.child("Progressions").child("Physique").exists())                            progn = dataSnapshot.child("Progressions").child("Physique").getValue(Integer.class);                        if (dataSnapshot.child("Progressions").child("Cognitive").exists())                            p = dataSnapshot.child("Progressions").child("Cognitive").getValue(Integer.class);                    }                    update_progress (progn);                    if (!sharedPreferences.contains(PROGRESS_COGNITIVE))                        update_progress_cognitive_prepar(p);                }            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });    }    private void getProgressCognitive (){        DatabaseReference root = FirebaseDatabase.getInstance().getReference().child("UserActivitys").child(MainMyMenu.user.getIdUser());        root.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                if (dataSnapshot.exists()) {                }                else                    return;            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });        DatabaseReference databaseReference = FirebaseDatabase.getInstance().getReference().child("UserActivitys").child(MainMyMenu.user.getIdUser()).child(today);        databaseReference.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot dataSnapshot) {                if (dataSnapshot.exists()) {                    int progn = 0;                    if (dataSnapshot.child("Progressions").exists()) {                        if (dataSnapshot.child("Progressions").child("Cognitive").exists())                            progn = dataSnapshot.child("Progressions").child("Cognitive").getValue(Integer.class);                    }else                        progn = 0;                    //pro2.setProgress(pro2.getProgress()+progn);                    update_progress_cognitive_prepar(progn);                }            }            @Override            public void onCancelled(@NonNull DatabaseError databaseError) {            }        });    }    //DATA    //__share data    public void Updates(int kca,int w){        SharedPreferences.Editor editor = sharedPreferences.edit();        editor.putInt("currentKca",kca);        editor.putInt("currentWater",w);        editor.commit();        editor.apply();    }    void Updates_plus (int a,int b,int c){        SharedPreferences.Editor editor = sharedPreferences.edit();        editor.putInt("protine",a);        editor.putInt("lipide",b);        editor.putInt("glucide",c);        editor.commit();        editor.apply();    }    public void Updates_water(int w){        SharedPreferences.Editor editor = sharedPreferences.edit();        editor.putInt("currentWater",w);        editor.apply();    }    public void Updates_nut(int kca){        SharedPreferences.Editor editor = sharedPreferences.edit();        editor.putInt("currentKca",kca);        editor.commit();        editor.apply();    }    private void update_progress(int progress) {        SharedPreferences.Editor editor = sharedPreferences.edit();        editor.putInt(PROGRESS_PHYSIQUE, progress);        editor.apply();    }    private void update_progress_cognitive_prepar(int i) {        //long result_time = share.getLong(PROGRESS_TIME,0);        int duree = i;        long result_time = duree*60000;        int minutes = (int) (result_time / 1000) / 60;        int seconds = (int) (result_time / 1000) % 60;        String timeLeftFormatted = String.format(Locale.getDefault(), "%02d:%02d", minutes, seconds);       // ActivitymoraleFragment.time_progress.setText(timeLeftFormatted);       // ActivitymoraleFragment.progressBar_cognitive.setProgress(duree);        SharedPreferences.Editor editor = sharedPreferences.edit();        editor.putInt(PROGRESS_COGNITIVE,duree);        editor.putLong(PROGRESS_COGNITIVE_TIME,result_time);        editor.apply();    }    //METHODES CALCUL    public Aliment getAliment (AlimentData a) {        ArrayList <Aliment> arrayList = MainMyMenu.arrayList;        for (int i = 0; i < arrayList.size(); i++) {            if (arrayList.get(i) != null && arrayList.get(i).getNom().trim().equals(a.getNom()))                return arrayList.get(i);        }        return null;    }    public double convertQttoClAliment(int quantite,Aliment aliment){        return (double)(quantite*aliment.getCalorie().getTotal())/100;    }    public double convertQttoClAliment(int quantite,Double kcal){        return (double)(quantite*kcal)/100;    }    //metohde of the interface TestInflate that make us get the data wrote on the Inflate Layout    @Override    public void applyTexts(int calories, double time, ExercicePhysique exercicePhysique) {        //get data and prepare them        Intent intent = new Intent(MainMyMenu.this, MainChrono.class);        intent.putExtra("Time",time);        MainChrono.exercicePhysique = exercicePhysique;        //launch ChronoActivty        startActivity(intent);    }    public void maladie_exo_list (){        maladie_exo.put(1,"");    }    //solution home / list ph rec    private void getRecList_home (int size){        if (MainMyMenu.exercicePhysiqueArrayList.size() <size)            size = MainMyMenu.exercicePhysiqueArrayList.size();        for(int i = 0; i<MainMyMenu.exercicePhysiqueArrayList.size() && i < size; i++){            for(int j=0;j<MainMyMenu.user.getObjectifs().size();j++){                if(MainMyMenu.exercicePhysiqueArrayList.get(i).getObjectif().equals(MainMyMenu.user.getObjectifs().get(j))){                    HomeFragment.arrayListhome.add(MainMyMenu.exercicePhysiqueArrayList.get(i));                }            }        }    }    ///CLEAR    void clear () {        AlimentData.nb = 0;    }    @SuppressLint("CommitPrefEdits")    void initapp () {        Calendar c = Calendar.getInstance();        //showMsg(+ "|" + Calendar.DAY_OF_MONTH);        SharedPreferences.Editor editor = sharedPreferences.edit();        if (sharedPreferences.contains("init_day")) {            showMsg ("begin"+sharedPreferences.getInt("init_day",Calendar.DAY_OF_MONTH));            if (sharedPreferences.getInt("init_day",c.get(Calendar.DAY_OF_MONTH)) < c.get(Calendar.DAY_OF_MONTH)) {                showMsg ("compare"+sharedPreferences.getInt("init_day",c.get(Calendar.DAY_OF_MONTH)));                editor.clear();                editor.apply();                clear();            }        } else {            showMsg("no contains");            editor.putInt("init_day",c.get(Calendar.DAY_OF_MONTH));            editor.apply();            showMsg ("day"+c.get(Calendar.DAY_OF_MONTH));            if (sharedPreferences.contains("init_day"))                showMsg ("contain2  "+sharedPreferences.getInt("init_day",0));        }    }    void changeAllUsers (User u,String mpAction) {        if (mpAction.equals("USER_MUST_CHANGE")) {            MainMyMenu.user = u;            ProfileFragment.user = u;           // ActivitymoraleFragment.user = u;           // ActivityphysicFragment.user = u;           // HomeFragment.user = u;        }    }}